name: Keep Codespace Alive for 24*7 by @DARKESPYT

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  run-codespace:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip
        pip3 install pexpect tmux

    - name: Authenticate with GitHub CLI
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}  # Make sure to add your GH_TOKEN to the repository secrets
      run: |
        echo $GH_TOKEN | gh auth login --with-token
        gh auth status

    - name: Start Codespace if stopped
      env:
        CODESPACE: fuzzy-space-palm-tree-5gq5jvwqjxrrfj6j
      run: |
        echo "Checking if Codespace is running..."
        STATUS=$(gh codespace list --json name,status --jq '.[] | select(.name == "${{ env.CODESPACE }}") | .status')
        echo "Codespace status: $STATUS"
        if [ "$STATUS" == "STOPPED" ]; then
          echo "Starting Codespace..."
          gh codespace start --codespace $CODESPACE
        fi
        echo "Waiting for Codespace to be ready..."
        while true; do
          STATUS=$(gh codespace list --json name,status --jq '.[] | select(.name == "${{ env.CODESPACE }}") | .status')
          if [ "$STATUS" == "RUNNING" ]; then
            echo "Codespace is running."
            break
          fi
        done

    - name: Run Python Script in Codespace
      env:
        CODESPACE: fuzzy-space-palm-tree-5gq5jvwqjxrrfj6j
        SCRIPT_PATH: /workspaces/src-forwarder/start.py
      run: |
        echo "Running script in Codespace ${CODESPACE}..."
        gh codespace ssh --codespace "${CODESPACE}" -- bash -c "python3 ${SCRIPT_PATH}"
        
